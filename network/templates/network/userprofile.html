{% extends 'network/layout.html' %}
{% load static %}

{% block body %}
  <div class="body">
    <div class="row justify-content-center">
      <div class="card card-body col-3 mt-2"> 
        <div id="myprofilecontainer"><h2>Profile for {{username}}</h2></div>
          <div id="followers" class="mt-3">Followed by {{ followers_count }} users</div>
          <div id="followedby" class="mt-3">Following {{ following_count }} users</div>
          <div id="ctas" class="mt-3">
            <button type="button" id='unfollowbtn' class="btn btn-danger">Unfollow</button>
            <button type="button" id='follow' class="btn btn-success">Follow</button>
          </div>
      </div>
      <div class="col-6 mt-2">
        <div id="postscontainer"></div>
        <!-- Pagination Starts -->
        <nav aria-label="Page navigation example">
          <ul class="pagination">
            <li class="page-item" ><a class="page-link" href="#" id="previousPageBtn">Previous</a></li>
            <li class="page-item mt-2 ml-2 mr-2" id="currentPageElement">  1 </li>
            <li class="page-item" ><a class="page-link" href="#" id="nextPageBtn">Next</a></li>
          </ul>
        </nav>
        <!-- Pagination Ends -->
      </div>
    </div>
  </div>

<script>
var relationship_exists = {{ relationship_exists }};
var userId = "{{ user_id }}";
var currentPage = 1;
var numPages = 1;
const previousPageElement = document.getElementById("previousPageBtn");
const currentPageElement = document.getElementById("currentPageElement");
const nextPageElement = document.getElementById("nextPageBtn");
const unfollowButton = document.getElementById('unfollowbtn');
const followButton = document.getElementById('follow');

previousPageElement.addEventListener("click", handlePreviousPageClick);
nextPageElement.addEventListener("click", handleNextPageClick);

followButton.addEventListener('click', function(){
  console.log("Clicked");
  fetch(`/addfollow/${userId}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': '{{ csrf_token }}',
    },
  })
  .then(response => response.json())
  .then(data => {
    // Handle the response data
    if (data.success) {
      // Display a success message
      alert(data.message);
      // Refresh the page
      window.location.reload();
    } else {
      // Display an error message
      alert(data.message);
    }
  })
  .catch(error => {
    // Handle any error that occurs during the request
    console.error('An error occurred:', error);
  });
});

unfollowButton.addEventListener('click', function(){
  console.log("Clicked");
  fetch(`/removefollow/${userId}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': '{{ csrf_token }}',
    },
  })
  .then(response => response.json())
  .then(data => {
    // Handle the response data
    if (data.success) {
      // Display a success message
      alert(data.message);
      // Refresh the page
      window.location.reload();
    } else {
      // Display an error message
      alert(data.message);
    }
  })
  .catch(error => {
    // Handle any error that occurs during the request
    console.error('An error occurred:', error);
  });
});

function handleFormSubmission(event) {
  event.preventDefault();
  const post = document.querySelector('#post').value;
  fetch('/create', {
    method: 'POST',
    body: JSON.stringify({
      postcontent: post
    })
  })
    .then((response) => response.json())
    .then((result) => {
      // Display success message in modal
      location.reload();
    })
    .catch((error) => {
      // Handle error
      console.error('An error occurred:', error);
    });
}

function updatePaginationCounter() {
  currentPageElement.innerHTML = "Page " + currentPage;
}

function handlePreviousPageClick() {
  if (currentPage > 1) {
    currentPage--;
    updatePaginationCounter();
    checkPreviousButtonVisibility(); 
    checkNextButtonVisibility();
    // Add your logic to fetch and display the previous page of content
    fetchPosts(userId); // Fetch previous page content using the updated currentPage value
  }
}

function checkPreviousButtonVisibility() {
  if (currentPage === 1) {
    previousPageElement.style.display = "none";
  } else {
    previousPageElement.style.display = "block";
  }
}

function handleNextPageClick() {
  console.log("Clicked 1");
  if (currentPage < numPages) {
    currentPage++;
    console.log(currentPage);
    updatePaginationCounter();
    checkNextButtonVisibility();
    checkPreviousButtonVisibility();
    // Add your logic to fetch and display the next page of content
    fetchPosts(userId); // Fetch next page content using the updated currentPage value
  }
}

function checkNextButtonVisibility() {
  if (currentPage === numPages) {
    nextPageElement.style.display = "none";
  } else {
    nextPageElement.style.display = "block";
  }
}

function removeAllChildNodes(parentNode) {
  while (parentNode.firstChild) {
    parentNode.removeChild(parentNode.firstChild);
  }
}

function showPosts(posts) {
  const postsContainer = document.querySelector("#postscontainer");
  // Remove all existing child nodes from postsContainer
  removeAllChildNodes(postsContainer);

  posts.forEach((serialized_post) => {
    const post_id = serialized_post.id;
    const content = serialized_post.content;
    const likes = serialized_post.likes;
    const unlikes = serialized_post.unlikes;
    const date_created = serialized_post.date_created;
    const user_id = serialized_post.user;
    const username = serialized_post.username;

    // Display each post in a div
    const postDiv = document.createElement("div");
    postDiv.classList.add("card", "card-body", "mb-3");

    // Display content in h5
    const headerElement = document.createElement("h5");
    headerElement.classList.add("card-title");
    headerElement.textContent = content;

    // Display other info
    const postElement = document.createElement("p");
    postElement.classList.add("card-text");

    // Create a clickable username link
    const usernameLink = document.createElement("a");
    usernameLink.textContent = `${username} Â·  ${date_created}`;
    usernameLink.href = `/userprofile/${user_id}`;

    // Append the username link and line break to postElement
    postElement.appendChild(usernameLink);
    postElement.appendChild(document.createElement("br"));
    postElement.innerHTML += `Likes: ${likes} <i class="far fa-thumbs-up"></i><br>`;

    // Append header and post elements to postDiv
    postDiv.appendChild(headerElement);
    postDiv.appendChild(postElement);

    postsContainer.appendChild(postDiv);
  });
}

function fetchPosts(user_id) {
  fetch(`/feed/${user_id}?page=${currentPage}`)
    .then((response) => response.json())
    .then((data) => {
      showPosts(data.serialized_posts);
      numPages = data.paginator.num_pages;
    })
    .catch((error) => {
      console.error("An error occurred:", error);
    });
}

// Initial pagination counter
updatePaginationCounter();

// On load logic
document.addEventListener('DOMContentLoaded', function () {

  fetchPosts(userId);
  checkPreviousButtonVisibility();
  if(relationship_exists) {
    // Set follow btn -> display none
    document.getElementById('follow').style.display = 'none';
    // Set unfollow btn -> display block  
    document.getElementById('unfollowbtn').style.display = 'block';
  } else {
    // Set follow btn -> display block
    document.getElementById('follow').style.display = 'block';  
    // Set unfollow btn -> display none
    document.getElementById('unfollowbtn').style.display = 'none';
  }

  document.querySelector('form').addEventListener('submit', handleFormSubmission);

});

  </script>
{% endblock %}
